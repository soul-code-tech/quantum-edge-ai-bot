name: Train & Update Weights

on:
  schedule:
    - cron: "*/30 * * * *"  # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:        # –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Checkout weights branch (shallow)
        run: |
          git fetch origin weights:weights
          git checkout weights
          # –û—á–∏—â–∞–µ–º –≤—Å—ë, –∫—Ä–æ–º–µ .gitkeep
          find . -type f ! -name ".gitkeep" -delete
          find . -type d ! -name "." ! -name "weights" -exec rm -rf {} + 2>/dev/null || true

      - name: Run training
        env:
          BINGX_API_KEY: ${{ secrets.BINGX_API_KEY }}
          BINGX_SECRET_KEY: ${{ secrets.BINGX_SECRET_KEY }}
        run: python scripts/train_all.py

      - name: Commit and push updated weights
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add weights/
          if ! git diff --cached --quiet; then
            git commit -m "ü§ñ Auto-update weights $(date -u)"
            git push origin weights
          else
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          fi
